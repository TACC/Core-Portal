# This compose file is useful for testing https.
---
version: "3"
services:
  redis:
    image: redis:4.0
    ports:
      - 6379:6379
    container_name: cep_redis
    hostname: cep_redis

  rabbitmq:
    image: rabbitmq:3.6.10-management
    volumes:
      - cep_rabbitmq_data:/var/lib/rabbitmq/mnesia/rabbit@des_rabbitmq
    env_file: ../env_files/rabbitmq.env
    ports:
      - 5672:5672
      - 5673:5673
      - 15673:15673
      - 15672:15672
    container_name: cep_rabbitmq
    hostname: cep_rabbitmq

  memcached:
    image: memcached:latest
    container_name: cep_memcached
    hostname: cep_memcached

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.5.1
    ulimits:
      memlock: -1
    environment:
      - ES_HEAP_SIZE:2g
    volumes:
      - cep_es_data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    container_name: cep_elasticsearch
    hostname: cep_elasticsearch

  mysql:
    image: mysql:5.6
    env_file: ../env_files/mysql.env
    ports:
      - 3306:3306
    container_name: cep_mysql
    hostname: cep_mysql

  nginx:
    image: nginx
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../nginx/gzip.conf:/etc/nginx/gzip.conf
      - ../nginx/dummy.crt:/etc/ssl/dummy.crt
      - ../nginx/dummy.key:/etc/ssl/dummy.key
      - ../nginx/dhparam.pem:/etc/ssl/dhparam.pem
      - ../../.:/srv/www/portal
    links:
      - django:django
    ports:
      - 80:80
      - 443:443
    container_name: cep_nginx
    hostname: cep_nginx

  django:
    image: cep-portal/portal:local
    # env_file: ../env_files/portal.env
    links:
      - memcached:memcached
      - mysql:mysql
      - rabbitmq:rabbitmq
      - redis:redis
      - elasticsearch:elasticsearch
    volumes:
      - ../../.:/srv/www/portal
      - ../../../client:/srv/www/client
      - ../../data/static:/var/www/portal/static
      - ../../data/media:/var/www/portal/media
    ports:
      - 8000:8000
      - 5555:5555
      - 9000:9000
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: ./manage.py runserver 0.0.0.0:8000
    container_name: cep_django
    hostname: cep_django

  workers:
    image: cep-portal/portal:local
    # env_file: ../env_files/portal.env
    links:
      - memcached:memcached
      - mysql:mysql
      - rabbitmq:rabbitmq
      - redis:redis
      - elasticsearch:elasticsearch
    volumes:
      - ../../.:/srv/www/portal
      - ../../data/static:/var/www/portal/static
      - ../../data/media:/var/www/portal/media
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: "celery -A portal worker -l debug"
    container_name: cep_workers
    hostname: cep_workers

volumes:
  cep_redis_data:
  cep_mysql_data:
  cep_es_data:
  cep_rabbitmq_data:
