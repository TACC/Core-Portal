# This compose file is useful for testing https.
# The .env file sets ENVVARS for the Docker CLI used by this compose file.
---
version: "3"
services:
  redis:
    image: redis:4.0
    volumes:
      - cep_prtl_redis_data:/data
    ports:
      - 6379:6379
    container_name: 3dem_prtl_redis
    hostname: 3dem_prtl_redis
    networks:
      - cep_prtl_net

  rabbitmq:
    image: rabbitmq:3.6.10-management
    volumes:
      - cep_prtl_rabbitmq_data:/var/lib/rabbitmq/mnesia/rabbit@cep_prtl_rabbitmq
    env_file: ../env_files/rabbitmq.env
    ports:
      - 5672:5672
      - 5673:5673
      - 15673:15673
      - 15672:15672
    container_name: 3dem_prtl_rabbitmq
    hostname: 3dem_prtl_rabbitmq
    networks:
      - cep_prtl_net

  memcached:
    image: memcached:latest
    container_name: 3dem_prtl_memcached
    hostname: 3dem_prtl_memcached
    networks:
      - cep_prtl_net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.3.2
    ulimits:
      memlock: -1
    environment:
      - ES_HEAP_SIZE:2g
    volumes:
      - ../elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - cep_prtl_es_data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    container_name: 3dem_prtl_elasticsearch
    hostname: 3dem_prtl_elasticsearch
    networks:
      - cep_prtl_net

  postgres:
    image: postgres:10.3
    volumes:
      - cep_prtl_postgres_data:/var/lib/postgresql/data/portal
    ports:
      - 5432:5432
    container_name: 3dem_prtl_postgres
    hostname: 3dem_prtl_postgres
    networks:
      - cep_prtl_net
    environment:
      - POSTGRES_PASSWORD=dev
      - POSTGRES_USER=dev
      - POSTGRES_DB=dev
      - PGDATA=/var/lib/postgresql/data/portal

  nginx:
    image: nginx
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../nginx/gzip.conf:/etc/nginx/gzip.conf
      - ../nginx/certificates/3dem.dev.crt:/etc/ssl/3dem.dev.crt
      - ../nginx/certificates/3dem.dev.key:/etc/ssl/3dem.dev.key
      - ../nginx/dhparam.pem:/etc/ssl/dhparam.pem
      - ../../../.:/srv/www/portal
    links:
      - django:django
      - websockets:websockets
    ports:
      - 80:80
      - 443:443
    container_name: 3dem_prtl_nginx
    hostname: 3dem_prtl_nginx
    networks:
      - cep_prtl_net

  websockets:
    image: neuronex-3dem-portal/portal:local
    links:
      - redis:redis
    volumes:
      - ../../../.:/srv/www/portal
    ports:
      - 9000:9000
    container_name: 3dem_prtl_websockets
    hostname: cep_prtl_websockets
    command: "uwsgi --chdir /srv/www/portal/server --gevent 1000 --workers=2 --http-websockets  --http-socket=:9000 --module portal.wsgi_websocket:application"
    networks:
      - cep_prtl_net

  django:
    image: neuronex-3dem-portal/portal:local
    # env_file: ../env_files/portal.env
    links:
      - memcached:memcached
      - postgres:postgres
      - rabbitmq:rabbitmq
      - redis:redis
      - elasticsearch:elasticsearch
    volumes:
      - ../../../.:/srv/www/portal
      - ../../data/static:/var/www/portal/server/static
      - ../../data/media:/var/www/portal/server/media
    ports:
      - 8000:8000
      - 5555:5555
    dns:
      - 8.8.8.8
      - 8.8.4.4
    stdin_open: true
    tty: true
    command: ['python', './manage.py', 'runserver', '0.0.0.0:8000']
    container_name: 3dem_prtl_django
    hostname: 3dem_prtl_django
    networks:
      - cep_prtl_net

  workers:
    image: neuronex-3dem-portal/portal:local
    # env_file: ../env_files/portal.env
    links:
      - memcached:memcached
      - postgres:postgres
      - rabbitmq:rabbitmq
      - redis:redis
      - elasticsearch:elasticsearch
    volumes:
      - ../../../.:/srv/www/portal
      - ../../data/static:/var/www/portal/server/static
      - ../../data/media:/var/www/portal/server/media
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: "celery -A portal worker -Q default,indexing,files,api,onboard --concurrency=2"
    container_name: 3dem_prtl_workers
    hostname: cep_prtl_workers
    networks:
      - cep_prtl_net

volumes:
  cep_prtl_redis_data:
  cep_prtl_es_data:
  cep_prtl_rabbitmq_data:
  cep_prtl_postgres_data:

networks:
  cep_prtl_net:
    driver: bridge
