---
# Django project should already been installed as well as Celery. This will only setup the daemon.

- name: Create Celery conf directory
  file: 
    path: "/etc/conf.d"
    state: "directory" 

- name: Create Celery pid directory
  file: 
    path: "/var/run/celery"
    state: "directory" 
    mode: "0755"
    owner: "{{celeryd_user}}" 
    group: "{{celeryd_group}}"
    recurse: yes

- name: Create Celery log directory
  file:
    path: "/var/log/celery"
    state: "directory" 
    mode: "0755"
    owner: "{{celeryd_user}}" 
    group: "{{celeryd_group}}"
    recurse: yes

- name: Write Celery conf 
  template: 
    src: "celeryd.conf.j2"
    dest: "/etc/conf.d/celery"
    mode: 0644
    owner: root
    group: root
    force: yes

- name: Write Celery systemd unit
  template: 
    src: "celeryd.service.j2"
    dest: "/usr/lib/systemd/system/celeryd.service"
    mode: 0644
    owner: root
    group: root
    force: yes

- name: Reload Daemon
  command: systemctl daemon-reload

- name: Enable Celery service
  command: systemctl enable celeryd

- name: Start Celery service
  command: systemctl start celeryd
  
- name: Restart Celery service
  command: systemctl restart celeryd
